<!DOCTYPE html>
<html>
<head>
    <title>Razorpay Test Mode</title>
    <script src="https://checkout.razorpay.com/v1/checkout.js"></script>
    <style>
        body { font-family: sans-serif; display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100vh; background: #f4f7f6; }
        .card { background: white; padding: 2rem; border-radius: 8px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); text-align: center; }
        button { background: #3399cc; color: white; border: none; padding: 10px 20px; border-radius: 4px; cursor: pointer; font-size: 16px; margin-top: 10px; }
        button:hover { background: #287a9e; }
    </style>
</head>
<body>

<div class="card">
    <h2>Razorpay Checkout Test</h2>
    <p>Simulating Checkout for Order ID: <input type="number" id="local_order_id" placeholder="Enter Order ID" style="padding: 5px; width: 100px;"></p>
    <p style="font-size: 12px; color: #666;">Note: Must be logged in (Sanctum Token required in headers if running outside browser session)</p>
    <button onclick="payNow()">Proceed to Payment</button>
</div>

<script>
function payNow() {
    const localOrderId = document.getElementById('local_order_id').value;
    if(!localOrderId) {
        alert("Please enter a valid local Order ID from your database.");
        return;
    }

    const apiBase = window.location.origin + '/api';
    
    // In a real frontend, you'd have the token stored
    const headers = {
        'Content-Type': 'application/json',
        'Accept': 'application/json'
        // 'Authorization': 'Bearer ' + token // Add if testing with Postman/outside session
    };

    // 1. Create Razorpay Order via Backend
    fetch(apiBase + '/razorpay/order', {
        method: 'POST',
        headers: headers,
        body: JSON.stringify({ order_id: localOrderId })
    })
    .then(res => res.json())
    .then(data => {
        if (data.error || !data.order_id) {
            alert("Error: " + (data.message || JSON.stringify(data)));
            return;
        }

        const options = {
            key: data.key,
            amount: data.amount,
            currency: data.currency,
            name: "SoloCart",
            description: "Payment for Order #" + localOrderId,
            order_id: data.order_id,
            handler: function (response) {
                // 2. Verify Payment
                fetch(apiBase + '/razorpay/verify', {
                    method: 'POST',
                    headers: headers,
                    body: JSON.stringify({
                        local_order_id: localOrderId,
                        razorpay_order_id: response.razorpay_order_id,
                        razorpay_payment_id: response.razorpay_payment_id,
                        razorpay_signature: response.razorpay_signature
                    })
                })
                .then(res => res.json())
                .then(result => {
                    alert(result.status.toUpperCase() + ": " + result.message);
                    if(result.status === 'success') {
                        location.reload(); // Refresh to show new state if needed
                    }
                });
            },
            prefill: {
                name: data.user.name,
                email: data.user.email,
                contact: data.user.phone
            },
            theme: { color: "#2874f0" }
        };

        const rzp = new Razorpay(options);
        rzp.open();
    })
    .catch(err => {
        console.error(err);
        alert("Request failed. Are you logged in?");
    });
}
</script>

</body>
</html>
